From 32c0d77eb39f685c152d8012f0bc980c09a9278a Mon Sep 17 00:00:00 2001
Date: Thu, 2 May 2024 22:53:25 +0800
Subject: [PATCH] make compilation work on old glibc<2.17 (for conda-forge)

---
 pypy/module/pyexpat/src/expat/expat_config.h | 8 ++++++--
 pypy/module/pyexpat/src/expat/xmlparse.c     | 1 +
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/pypy/module/pyexpat/src/expat/expat_config.h b/pypy/module/pyexpat/src/expat/expat_config.h
index 266ef52cbf..202a6cadd6 100644
--- a/pypy/module/pyexpat/src/expat/expat_config.h
+++ b/pypy/module/pyexpat/src/expat/expat_config.h
@@ -11,8 +11,12 @@
 #ifdef __APPLE__
   #define HAVE_ARC4RANDOM_BUF
 #elif defined __GNUC__
-  // #define HAVE_GETRANDOM 1
-  #define HAVE_SYSCALL_GETRANDOM
+  // requires features.h
+  #if __GLIBC__ == 2 && __GLIBC_MINOR__ < 17
+    #define XML_DEV_URANDOM
+  #else
+    #define HAVE_SYSCALL_GETRANDOM
+  #endif
   //#define HAVE_GETRANDOM_SYSCALL = 1
   #define HAVE_LINUX_RANDOM_H = 1
   // #define HAVE_SYS_RANDOM_H 1
diff --git a/pypy/module/pyexpat/src/expat/xmlparse.c b/pypy/module/pyexpat/src/expat/xmlparse.c
index c210c28fb7..458e9580b6 100644
--- a/pypy/module/pyexpat/src/expat/xmlparse.c
+++ b/pypy/module/pyexpat/src/expat/xmlparse.c
@@ -63,6 +63,7 @@
 
 #define XML_BUILDING_EXPAT 1
 
+#include <features.h>
 #include "expat_config.h"
 
 #if ! defined(XML_GE) || (1 - XML_GE - 1 == 2) || (XML_GE < 0) || (XML_GE > 1)
-- 

